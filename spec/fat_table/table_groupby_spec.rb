# frozen_string_literal: true

module FatTable
  RSpec.describe Table do
    describe 'group_by' do
      let(:tab) do
        aoa = [
          %w[Ref Date Code Raw Shares Price Info Bool],
          [1,  '2013-05-02', 'P', 795_546.20, 795_546.2, 1.1850,  'ZMPEF1', 'T'],
          [2,  '2013-05-02', 'P', 118_186.40, 118_186.4, 11.8500, 'ZMPEF1', 'T'],
          [7,  '2013-05-20', 'S', 12_000.00,  5046.00,   28.2804, 'ZMEAC',  'F'],
          [8,  '2013-05-20', 'S', 85_000.00,  35_742.50, 28.3224, 'ZMEAC',  'T'],
          [9,  '2013-05-20', 'S', 33_302.00,  14_003.49, 28.6383, 'ZMEAC',  'T'],
          [10, '2013-05-23', 'S', 8000.00,    3364.00,   27.1083, 'ZMEAC',  'T'],
          [11, '2013-05-23', 'S', 23_054.00,  9694.21,   26.8015, 'ZMEAC',  'F'],
          [12, '2013-05-23', 'S', 39_906.00,  16_780.47, 25.1749, 'ZMEAC',  'T'],
          [13, '2013-05-29', 'S', 13_459.00,  5659.51,   24.7464, 'ZMEAC',  'T'],
          [14, '2013-05-29', 'S', 15_700.00,  6601.85,   24.7790, 'ZMEAC',  'F'],
          [15, '2013-05-29', 'S', 15_900.00,  6685.95,   24.5802, 'ZMEAC',  'T'],
          [16, '2013-05-30', 'S', 6_679.00,   2808.52,   25.0471, 'ZMEAC',  'T'],
        ]
        Table.from_aoa(aoa)
      end

      let(:tab1) do
        tab1_str = <<-EOS
            | Ref  | Date             | Code |  Price | G10 | QP10 | Shares |   LP |    QP |   IPLP |   IPQP |
            |------+------------------+------+--------+-----+------+--------+------+-------+--------+--------|
            | T001 | [2016-11-01 Tue] | P    | 7.7000 | T   | F    |    100 |   14 |    86 | 0.2453 | 0.1924 |
            | T002 | [2016-11-01 Tue] | P    | 7.7500 | T   | F    |    200 |   28 |   172 | 0.2453 | 0.1924 |
            | T003 | [2016-11-01 Tue] | P    | 7.5000 | F   | T    |    800 |  112 |   688 | 0.2453 | 0.1924 |
            | T003 | [2016-11-01 Tue] | P    | 7.5000 | F   | T    |    800 |  112 |   688 | 0.2453 | 0.1924 |
            |------+------------------+------+--------+-----+------+--------+------+-------+--------+--------|
            | T004 | [2016-11-01 Tue] | S    | 7.5500 | T   | F    |   6811 |  966 |  5845 | 0.2453 | 0.1924 |
            | T005 | [2016-11-01 Tue] | S    | 7.5000 | F   | F    |   4000 |  572 |  3428 | 0.2453 | 0.1924 |
            | T006 | [2016-11-01 Tue] | S    | 7.6000 | F   | T    |   1000 |  143 |   857 | 0.2453 | 0.1924 |
            | T006 | [2016-11-01 Tue] | S    | 7.6000 | F   | T    |   1000 |  143 |   857 | 0.2453 | 0.1924 |
            | T007 | [2016-11-01 Tue] | S    | 7.6500 | T   | F    |    200 |   28 |   172 | 0.2453 | 0.1924 |
            | T008 | [2016-11-01 Tue] | P    | 7.6500 | F   | F    |   2771 |  393 |  2378 | 0.2453 | 0.1924 |
            | T009 | [2016-11-01 Tue] | P    | 7.6000 | F   | F    |   9550 | 1363 |  8187 | 0.2453 | 0.1924 |
            |------+------------------+------+--------+-----+------+--------+------+-------+--------+--------|
            | T010 | [2016-11-01 Tue] | P    | 7.5500 | F   | T    |   3175 |  451 |  2724 | 0.2453 | 0.1924 |
            | T011 | [2016-11-02 Wed] | P    | 7.4250 | T   | F    |    100 |   14 |    86 | 0.2453 | 0.1924 |
            | T012 | [2016-11-02 Wed] | P    | 7.5500 | F   | F    |   4700 |  677 |  4023 | 0.2453 | 0.1924 |
            | T012 | [2016-11-02 Wed] | P    | 7.5500 | F   | F    |   4700 |  677 |  4023 | 0.2453 | 0.1924 |
            | T013 | [2016-11-02 Wed] | P    | 7.3500 | T   | T    |  53100 | 7656 | 45444 | 0.2453 | 0.1924 |
            |------+------------------+------+--------+-----+------+--------+------+-------+--------+--------|
            | T014 | [2016-11-02 Wed] | P    | 7.4500 | F   | T    |   5847 |  835 |  5012 | 0.2453 | 0.1924 |
            | T015 | [2016-11-02 Wed] | P    | 7.7500 | F   | F    |    500 |   72 |   428 | 0.2453 | 0.1924 |
            | T016 | [2016-11-02 Wed] | P    | 8.2500 | T   | T    |    100 |   14 |    86 | 0.2453 | 0.1924 |
        EOS
        FatTable.from_org_string(tab1_str)
      end

      it 'is able to group by equal columns' do
        tab2 = tab.group_by(
          :date,
          :code,
          shares: :sum,
          price: :avg,
          ref: :range,
          bool: :all?,
        )
        expect(tab2.headers).to eq([
          :date,
          :code,
          :sum_shares,
          :avg_price,
          :range_ref,
          :all_bool,
        ])
        expect(tab2[0][:sum_shares]).to eq(913732.6)
        expect(tab2[1][:sum_shares]).to eq(54791.99)
        expect(tab2[0][:avg_price]).to eq(6.5175)
        expect(tab2[1][:avg_price]).to eq(28.4137)
      end

      it 'can perform README example' do
        org_tab = tab1.group_by(
          :code,
          :date,
          price: :avg,
                                shares: :sum,
          lp: :sum,
          qp: :sum,
                                qp10: :all?,
        )
                    .to_org { |f| f.format(avg_price: '0.5R') }
        expected_org = <<~ORG
          |------+------------------+-----------+------------+--------+--------+----------|
          | Code | Date             | Avg Price | Sum Shares | Sum Lp | Sum Qp | All QP10 |
          |------+------------------+-----------+------------+--------+--------+----------|
          | P    | [2016-11-01 Tue] |   7.60714 | 17396      | 2473   | 14923  | F        |
          | P    | [2016-11-02 Wed] |   7.61786 | 69047      | 9945   | 59102  | F        |
          | S    | [2016-11-01 Tue] |   7.58000 | 13011      | 1852   | 11159  | F        |
          |------+------------------+-----------+------------+--------+--------+----------|
        ORG
        expect(org_tab).to eq(expected_org)
      end
    end
  end
end
